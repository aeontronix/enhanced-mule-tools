image: "kloudtek/kt-build-docker-image:latest"

variables:
  MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dgpg.passphrase=${PGP_PW} -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
  GITLAB_MAVEN_JOBTOKEN: "gitlab-ci"

cache:
  paths:
    - .m2/repository

stages:
  - build
  - release
  - release-sonatype

build-master:
  stage: build
  except:
    - tags
  only:
    - master
  script:
    - /usr/bin/prepare-build
    - mvn $MAVEN_CLI_OPTS deploy -DaltDeploymentRepository=aeontronix-private::default::https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/maven

build-other:
  stage: build
  script:
    - mvn $MAVEN_CLI_OPTS verify
  except:
    - tags
    - master

release:
  only:
    - master
  stage: release
  when: manual
  script:
    - /usr/bin/prepare-build
    - git config --global user.email "info@aeontronix.com"
    - git config --global user.name "Aeontronix CI"
    - git remote set-url origin git@gitlab.com:${CI_PROJECT_PATH}.git
    - git branch release-$(xmlstarlet sel -N p=http://maven.apache.org/POM/4.0.0 -t -v /p:project/p:version/text() pom.xml | sed s/-SNAPSHOT//)
    - mvn $MAVEN_CLI_OPTS versions:set -DprocessAllModules=true -DgroupId='*' -DartifactId='*' -DnewVersion=$(xmlstarlet sel -N p=http://maven.apache.org/POM/4.0.0 -t -v /p:project/p:version/text() pom.xml | sed s/-SNAPSHOT//)
    - mvn $MAVEN_CLI_OPTS deploy -DaltDeploymentRepository=aeontronix-private::default::https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/maven
    - git commit -a -m "release $(xmlstarlet sel -N p=http://maven.apache.org/POM/4.0.0 -t -v /p:project/p:version/text() pom.xml | sed s/-SNAPSHOT//)"
    - git tag v$(xmlstarlet sel -N p=http://maven.apache.org/POM/4.0.0 -t -v /p:project/p:version/text() pom.xml | sed s/-SNAPSHOT//)
    - git checkout ${CI_COMMIT_REF_NAME}
    - git branch -D release-$(xmlstarlet sel -N p=http://maven.apache.org/POM/4.0.0 -t -v /p:project/p:version/text() pom.xml | sed s/-SNAPSHOT//)
    - git push --tags -o ci.skip
  artifacts:
    paths:
      - target/*.jar

release-sonatype:
  only:
    - master
  stage: release-sonatype
  when: manual
  script:
    - /usr/bin/prepare-build
    - git checkout v$(xmlstarlet sel -N p=http://maven.apache.org/POM/4.0.0 -t -v /p:project/p:version/text() pom.xml | sed s/-SNAPSHOT//)
    - mvn $MAVEN_CLI_OPTS deploy -DaltDeploymentRepository=aeontronix-private::default::https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/maven
