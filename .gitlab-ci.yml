image: "kloudtek/kt-build-docker-image:latest"

variables:
  MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dgpg.passphrase=${PGP_PW} -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
  MAVEN_REPO_OPTS: "-DaltDeploymentRepository=aeontronix-private::default::https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/maven"
  GITLAB_MAVEN_JOBTOKEN: "gitlab-ci"

cache:
  paths:
    - .m2/repository

stages:
  - Build
  - Release
  - Publish Docs

build-master:
  stage: Build
  except:
    - tags
  only:
    - master
  script:
    - source prepare-build
    - mvn $MAVEN_CLI_OPTS package ${MAVEN_REPO_OPTS}
    - mvn $MAVEN_CLI_OPTS versions:set -DprocessAllModules=true -DgroupId='*' -DartifactId='*' -DnewVersion=${POM_REL_VERSION}
  artifacts:
    paths:
      - pom.xml
      - "*/pom.xml"

verify-docs:
  stage: Build
  except:
    - tags
  only:
    - master
  script:
    - source prepare-build
    - mvn $MAVEN_CLI_OPTS site

build-other:
  stage: Build
  script:
    - mvn $MAVEN_CLI_OPTS verify
  except:
    - tags
    - master

release:
  only:
    - master
  stage: Release
  when: manual
  allow_failure: false
  script:
    - more pom.xml
    - prepare-build
    - git config --global user.email "info@aeontronix.com"
    - git config --global user.name "Aeontronix CI"
    - git remote set-url origin git@gitlab.com:${CI_PROJECT_PATH}.git
    - git branch release-${POM_REL_VERSION}
  #    - mvn $MAVEN_CLI_OPTS deploy ${MAVEN_REPO_OPTS}
  #    - git commit -a -m "release ${POM_REL_VERSION}"
  #    - git tag v${POM_REL_VERSION}
  #    - git checkout ${CI_COMMIT_REF_NAME}
  #    - git branch -D release-${POM_REL_VERSION}
  #    - git push --tags -o ci.skip
  artifacts:
    paths:
      - target/*.jar
      - "*/target/*.jar"

pages:
  stage: Publish Docs
  only:
    - master
  script:
    - prepare-build
    - mvn $MAVEN_CLI_OPTS site site:deploy
  artifacts:
    paths:
      - public
